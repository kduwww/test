<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lean Menu - Elite Edition</title> 
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="menu-wrapper">
                    <div class="external-scrollbar">
                <div class="scroll-arrow scroll-arrow-up">â–²</div>
                <div class="custom-scrollbar">
                    <div class="custom-scrollbar-thumb" id="customScrollbarThumb"></div>
                    <div class="scrollbar-indicator" id="scrollbarIndicator"></div>
                </div>
                <div class="scroll-arrow scroll-arrow-down">â–¼</div>
            </div>
        
        <div class="menu-container" id="mainMenu">
            <div class="menu-header" id="menuHeader">
                <div class="header-home-text" id="headerText" role="heading" aria-level="1">HOME</div> 
                <span class="sr-only">Aura Menu - Use arrow keys to navigate, Enter to select, Backspace to go back</span>
            </div>

            <div class="menu-items" id="menuItemsContainer" role="menu" aria-label="Menu Options">
                <div class="highlight-bar" aria-hidden="true"></div> 
            </div>

            <div class="menu-footer">
                <span class="version">Version: Beta | 24hrs ago | Created By 0oox</span>
                <span class="counter" id="counter" aria-label="Menu position">1/9</span> 
            </div>
        </div>
    </div>

    <div class="notification-container" id="notificationContainer">
    </div>

    <script>
        const bannerImageUrl = 'style-image/Atlas.png'; // Default Homer Atlas header image 

        let currentIndex = 0; 
        let currentMenuType = 'main';
        let menuPath = ['HOME'];

        const menuContainer = document.getElementById('mainMenu'); 
        const headerText = document.getElementById('headerText'); 
        const menuItemsContainer = document.getElementById('menuItemsContainer'); 
        let highlightBar = document.querySelector('.highlight-bar'); 
        const counterElement = document.getElementById('counter'); 
        const notificationContainer = document.getElementById('notificationContainer');

        const menuData = {
            main: {
                title: 'HOME',
                items: [
                    { name: "Self", icon: '<i class="fa-solid fa-user"></i>', desc: "Player Options", action: "self" },
                    { name: "Online", icon: '<i class="fa-solid fa-desktop"></i>', desc: "Online Features", action: "online" },
                    { name: "Combat/Weapons", icon: '<i class="fa-solid fa-crosshairs"></i>', desc: "Weapon System", action: "combat" },
                    { name: "Visual", icon: '<i class="fa-solid fa-eye"></i>', desc: "Visual Effects", action: "visual" },
                    { name: "Vehicle", icon: '<i class="fa-solid fa-car"></i>', desc: "Vehicle Menu", action: "vehicle" },
                    { name: "Miscellaneous", icon: '<i class="fa-solid fa-folder-open"></i>', desc: "Other Options", action: "misc" },
                    { name: "Destructive", icon: '<i class="fa-solid fa-bomb"></i>', desc: "Destruction Tools", action: "destructive" },
                    { name: "Triggers", icon: '<i class="fa-solid fa-bolt"></i>', desc: "Event Triggers", action: "triggers" },
                    { name: "Settings", icon: '<i class="fa-solid fa-gear"></i>', desc: "System Settings", action: "settings" }
                ]
            },
            self: {
                title: 'SELF',
                items: [
                    { name: "Noclip", action: "noclip_toggle", type: "toggle", checked: false },
                    { name: "Give Armor", icon: '<i class="fa-solid fa-shield"></i>', desc: "Give yourself full armor", action: "give_armor" },
                ]
            },
            settings: {
                title: 'SETTINGS',
                items: [
                    { name: "Style", icon: '<i class="fa-solid fa-palette"></i>', desc: "Menu Style Options", action: "style" },
                ]
            },
            style: {
                title: 'STYLE',
                items: [
                    { name: "ATLAS-1", icon: '<i class="fa-solid fa-1"></i>', desc: "Style Option 1", action: "style_1" },
                    { name: "ATLAS-2", icon: '<i class="fa-solid fa-2"></i>', desc: "Style Option 2", action: "style_2" },
                    { name: "ATLAS-3", icon: '<i class="fa-solid fa-3"></i>', desc: "Style Option 3", action: "style_3" },
                ]
            }
        };

        function renderMenuItems(menuType) {
            const currentMenuData = menuData[menuType];
            let itemsHtml = '<div class="highlight-bar" aria-hidden="true"></div>'; 

            currentMenuData.items.forEach((item, index) => {
                if (item.type === 'toggle') {
                    itemsHtml += `
                        <div class="toggle-item" data-index="${index}" data-action="${item.action}" tabindex="0" role="button" aria-pressed="${item.checked}">
                            <div class="toggle-text">${item.name}</div>
                            <div class="toggle-switch ${item.checked ? 'on' : 'off'}"></div>
                        </div>
                    `;
                } else {
                    itemsHtml += `
                        <div class="menu-item" data-index="${index}" data-action="${item.action}" tabindex="0" role="menuitem">
                            <div class="icon">${item.icon}</div>
                            <div class="text">${item.name}</div>
                            <div class="arrow">Â»</div>
                        </div>
                    `;
                }
            });
            menuItemsContainer.innerHTML = itemsHtml;
            
            highlightBar = document.querySelector('.highlight-bar');

            const renderedItems = document.querySelectorAll('#menuItemsContainer .menu-item, #menuItemsContainer .toggle-item');
            
            // Update custom scrollbar after rendering new items
            setTimeout(() => {
                updateCustomScrollbar();
                updateScrollbarIndicator();
            }, 10);
            
            // Enhanced event handling with keyboard support
            renderedItems.forEach((itemElement, index) => {
                // Click handling
                itemElement.addEventListener('click', function() {
                    handleItemSelection(index, itemElement);
                });
                
                // Keyboard handling for individual items
                itemElement.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter' || event.key === ' ') {
                        event.preventDefault();
                        handleItemSelection(index, itemElement);
                    }
                });
                
                // Focus management
                itemElement.addEventListener('focus', function() {
                    // Update currentIndex when item is focused
                    currentIndex = index;
                    updateSelection(currentIndex, currentMenuType);
                });
                
                // Hover effects for better UX
                itemElement.addEventListener('mouseenter', function() {
                    if (!this.classList.contains('selected')) {
                        this.style.backgroundColor = 'rgba(255, 255, 255, 0.05)';
                    }
                });
                
                itemElement.addEventListener('mouseleave', function() {
                    if (!this.classList.contains('selected')) {
                        this.style.backgroundColor = '';
                    }
                });
            });

            return renderedItems; 
        }
        
        function handleItemSelection(index, itemElement) {
            const action = itemElement.dataset.action;
            const itemData = menuData[currentMenuType].items[index];

            if (itemElement.classList.contains('toggle-item')) {
                // Handle toggle items
                itemData.checked = !itemData.checked;
                const toggleSwitch = itemElement.querySelector('.toggle-switch');
                toggleSwitch.classList.toggle('on', itemData.checked);
                toggleSwitch.classList.toggle('off', !itemData.checked);
                
                // Update ARIA state
                itemElement.setAttribute('aria-pressed', itemData.checked);

                if (typeof GetParentResourceName !== 'undefined') {
                    fetch(`https://${GetParentResourceName()}/noclipToggle`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json; charset=UTF-8' },
                        body: JSON.stringify({ state: itemData.checked })
                    }).catch(error => console.error('Error sending noclipToggle:', error));
                }

                showNotification(
                    itemData.checked ? 'Noclip Activated' : 'Noclip Deactivated',
                    itemData.checked ? 'Noclip mode enabled.' : 'Noclip mode disabled.',
                    itemData.checked ? '<i class="fa-solid fa-toggle-on"></i>' : '<i class="fa-solid fa-toggle-off"></i>'
                );

                updateSelection(index, currentMenuType);
            } else {
                // Handle regular menu items
                updateSelection(index, currentMenuType);
                selectEffect(index, currentMenuType);
            }
        }

        function setHeaderImage(imageUrl) {
            const header = document.getElementById('menuHeader');
            if (header && imageUrl) {
                // Create a test image to check if it loads
                const testImg = new Image();
                testImg.onload = function() {
                    console.log('âœ… Image loaded successfully:', imageUrl);
                    header.style.backgroundImage = `url('${imageUrl}'), linear-gradient(135deg, rgba(255, 215, 0, 0.95) 0%, rgba(255, 165, 0, 0.95) 100%)`;
                    header.style.backgroundSize = 'cover, cover';
                    header.style.backgroundPosition = 'center, center';
                    header.style.backgroundRepeat = 'no-repeat, no-repeat';
                };
                testImg.onerror = function() {
                    console.error('âŒ Failed to load image:', imageUrl);
                    // Fallback to gradient only
                    header.style.backgroundImage = 'linear-gradient(135deg, rgba(255, 215, 0, 0.95) 0%, rgba(255, 165, 0, 0.95) 100%)';
                };
                testImg.src = imageUrl;
            }
        }

        function updateSelection(index, menuType) {
            const currentItems = document.querySelectorAll('#menuItemsContainer .menu-item, #menuItemsContainer .toggle-item');
            const totalItems = currentItems.length;

            if (currentItems[currentIndex]) {
                currentItems[currentIndex].classList.remove('selected');
            }
            
            currentIndex = index;

            if (totalItems > 0 && index >= 0 && index < totalItems) {
                currentItems[index].classList.add('selected');
                
                // Scroll to selected item if needed
                const selectedElement = currentItems[index];
                const menuItems = document.getElementById('menuItemsContainer');
                const itemTop = selectedElement.offsetTop;
                const itemHeight = selectedElement.offsetHeight;
                const containerHeight = menuItems.clientHeight;
                const scrollTop = menuItems.scrollTop;
                
                if (itemTop < scrollTop) {
                    menuItems.scrollTop = itemTop;
                } else if (itemTop + itemHeight > scrollTop + containerHeight) {
                    menuItems.scrollTop = itemTop + itemHeight - containerHeight;
                }
            }

            if (highlightBar) {
                if (totalItems > 0 && index >= 0 && index < totalItems) {
                    const selectedElement = currentItems[index]; 
                    const topPosition = selectedElement.offsetTop; 
                    highlightBar.style.top = `${topPosition}px`; 
                    highlightBar.style.display = 'block';
                } else {
                    highlightBar.style.display = 'none';
                }
            }
            
            // Update scrollbar indicator
            updateScrollbarIndicator();
            
            counterElement.textContent = `${(totalItems > 0 && index >= 0) ? index + 1 : 0}/${totalItems}`;
        }

        function selectEffect(index, menuType) {
            const selectedOption = menuData[menuType].items[index];
            if (!selectedOption) return;

            if (menuType === 'main' && selectedOption.action === 'self') {
                currentMenuType = 'self';
                menuPath = ['HOME', 'SELF'];
                updateBreadcrumb();
                renderMenuItems(currentMenuType);
                updateSelection(0, currentMenuType);
                updateScrollbarIndicator();
            } else if (menuType === 'main' && selectedOption.action === 'settings') {
                currentMenuType = 'settings';
                menuPath = ['HOME', 'SETTINGS'];
                updateBreadcrumb();
                renderMenuItems(currentMenuType);
                updateSelection(0, currentMenuType);
                updateScrollbarIndicator();
            } else if (menuType === 'settings' && selectedOption.action === 'style') {
                currentMenuType = 'style';
                menuPath = ['HOME', 'SETTINGS', 'STYLE'];
                updateBreadcrumb();
                renderMenuItems(currentMenuType);
                updateSelection(0, currentMenuType);
                updateScrollbarIndicator();
            } else if (selectedOption.action === 'style_1') {
                applyAtlasStyle();
                showNotification('Style Applied', 'Atlas-1 style has been applied to the menu.', 3000, "success");
            } else if (selectedOption.action === 'style_2') {
                applyAtlas2Style();
                showNotification('Style Applied', 'Atlas-2 style has been applied to the menu.', 3000, "success");
            } else if (selectedOption.action === 'style_3') {
                applyAtlas3Style();
                showNotification('Style Applied', 'Atlas-3 style has been applied to the menu.', 3000, "success");
            } else if (selectedOption.action === 'give_armor') {
                if (typeof GetParentResourceName !== 'undefined') {
                    fetch(`https://${GetParentResourceName()}/giveArmor`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json; charset=UTF-8' },
                        body: JSON.stringify({})
                    }).then(res => res.json()).then(resp => {
                        console.log("Armor given:", resp);
                        showNotification('Armor Given', 'Full armor has been applied!', 3000, "success");
                    }).catch(error => {
                        console.error('Error giving armor:', error);
                        showNotification('Error', 'Failed to give armor', 3000, "error");
                    });
                }
            } else if (typeof GetParentResourceName !== 'undefined') {
                fetch(`https://${GetParentResourceName()}/menuSelected`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json; charset=UTF-8' },
                    body: JSON.stringify({ action: selectedOption.action, index: index, menu: menuType })
                });
            }
        }

        function updateBreadcrumb() {
            if (headerText) {
                headerText.textContent = menuPath.join(' >> ');
            }
        }

        function applyAtlasStyle() {
            // Apply Atlas style with dark blue theme
            const menuContainer = document.getElementById('mainMenu');
            const header = document.getElementById('menuHeader');
            
            if (menuContainer) {
                menuContainer.style.background = 'rgba(0, 0, 0, 0.6)';
                menuContainer.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.6), inset 0 0 8px rgba(255, 255, 255, 0.05)';
            }
            
            if (header) {
                header.style.background = 'linear-gradient(135deg, rgba(30, 50, 80, 0.95) 0%, rgba(20, 35, 60, 0.95) 100%)';
                header.style.backgroundImage = 'url("style-image/ATLAS-1.png"), linear-gradient(135deg, rgba(30, 50, 80, 0.95) 0%, rgba(20, 35, 60, 0.95) 100%)';
                header.style.backgroundSize = 'cover, cover';
                header.style.backgroundPosition = 'center, center';
                header.style.backgroundRepeat = 'no-repeat, no-repeat';
            }
            
            // Update scrollbar colors
            const externalScrollbar = document.querySelector('.external-scrollbar');
            if (externalScrollbar) {
                externalScrollbar.style.background = 'rgba(0, 0, 0, 0.6)';
                externalScrollbar.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.6), inset 0 0 8px rgba(255, 255, 255, 0.05)';
            }
            
            // Update scrollbar indicator to white/blue theme
            const scrollbarIndicator = document.getElementById('scrollbarIndicator');
            if (scrollbarIndicator) {
                scrollbarIndicator.style.background = 'linear-gradient(180deg, #ffffff 0%, #e0e8ff 100%)';
                scrollbarIndicator.style.boxShadow = '0 0 6px rgba(255, 255, 255, 0.8), 0 0 12px rgba(255, 255, 255, 0.4), inset 0 1px 1px rgba(255, 255, 255, 0.3)';
                scrollbarIndicator.style.border = '1px solid rgba(255, 255, 255, 0.6)';
            }
            
            // Update scroll arrows to white
            const scrollArrows = document.querySelectorAll('.scroll-arrow');
            scrollArrows.forEach(arrow => {
                arrow.style.color = 'rgba(255, 255, 255, 0.8)';
            });
            
            // Update highlight bar to white/blue
            const highlightBar = document.querySelector('.highlight-bar');
            if (highlightBar) {
                highlightBar.style.background = 'rgba(255, 255, 255, 0.1)';
            }
            
            // Update selected text colors to white
            const style = document.createElement('style');
            style.textContent = `
                .menu-item.selected .text { color: #ffffff !important; }
                .menu-item.selected .icon { color: #ffffff !important; }
                .menu-item.selected .arrow { color: #ffffff !important; }
                .toggle-item.selected .toggle-text { color: #ffffff !important; }
                .header-home-text { color: #ffffff !important; }
                .menu-footer .counter { background: rgba(255, 255, 255, 0.1) !important; color: #ffffff !important; box-shadow: 0 1px 3px rgba(255, 255, 255, 0.2) !important; }
                .notification { background: rgba(15, 25, 45, 0.95) !important; border: 1px solid rgba(255, 255, 255, 0.4) !important; }
                .notification-icon { color: #ffffff !important; }
                .notification-title { color: #ffffff !important; }
                .notification-message { color: #e0e8ff !important; }
                .notification-timer { background: #ffffff !important; }
            `;
            document.head.appendChild(style);
        }

        function applyAtlas2Style() {
            // Apply Atlas-2 style with metallic silver theme
            const menuContainer = document.getElementById('mainMenu');
            const header = document.getElementById('menuHeader');
            
            if (menuContainer) {
                menuContainer.style.background = 'rgba(0, 0, 0, 0.6)';
                menuContainer.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.6), inset 0 0 8px rgba(192, 192, 192, 0.1)';
            }
            
            if (header) {
                header.style.background = 'linear-gradient(135deg, rgba(20, 30, 50, 0.95) 0%, rgba(15, 25, 40, 0.95) 100%)';
                header.style.backgroundImage = 'url("style-image/ATLAS-2.png"), linear-gradient(135deg, rgba(20, 30, 50, 0.95) 0%, rgba(15, 25, 40, 0.95) 100%)';
                header.style.backgroundSize = 'cover, cover';
                header.style.backgroundPosition = 'center, center';
                header.style.backgroundRepeat = 'no-repeat, no-repeat';
            }
            
            // Update scrollbar colors
            const externalScrollbar = document.querySelector('.external-scrollbar');
            if (externalScrollbar) {
                externalScrollbar.style.background = 'rgba(0, 0, 0, 0.6)';
                externalScrollbar.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.6), inset 0 0 8px rgba(192, 192, 192, 0.1)';
            }
            
            // Update scrollbar indicator to metallic silver theme
            const scrollbarIndicator = document.getElementById('scrollbarIndicator');
            if (scrollbarIndicator) {
                scrollbarIndicator.style.background = 'linear-gradient(180deg, #c0c0c0 0%, #a0a0a0 100%)';
                scrollbarIndicator.style.boxShadow = '0 0 6px rgba(192, 192, 192, 0.8), 0 0 12px rgba(192, 192, 192, 0.4), inset 0 1px 1px rgba(255, 255, 255, 0.3)';
                scrollbarIndicator.style.border = '1px solid rgba(192, 192, 192, 0.6)';
            }
            
            // Update scroll arrows to metallic silver
            const scrollArrows = document.querySelectorAll('.scroll-arrow');
            scrollArrows.forEach(arrow => {
                arrow.style.color = 'rgba(192, 192, 192, 0.8)';
            });
            
            // Update highlight bar to metallic silver
            const highlightBar = document.querySelector('.highlight-bar');
            if (highlightBar) {
                highlightBar.style.background = 'rgba(192, 192, 192, 0.15)';
            }
            
            // Update selected text colors to metallic silver
            const style = document.createElement('style');
            style.textContent = `
                .menu-item.selected .text { color: #c0c0c0 !important; }
                .menu-item.selected .icon { color: #c0c0c0 !important; }
                .menu-item.selected .arrow { color: #c0c0c0 !important; }
                .toggle-item.selected .toggle-text { color: #c0c0c0 !important; }
                .header-home-text { color: #c0c0c0 !important; }
                .menu-footer .counter { background: rgba(192, 192, 192, 0.15) !important; color: #c0c0c0 !important; box-shadow: 0 1px 3px rgba(192, 192, 192, 0.3) !important; }
                .notification { background: rgba(20, 30, 50, 0.95) !important; border: 1px solid rgba(192, 192, 192, 0.4) !important; }
                .notification-icon { color: #c0c0c0 !important; }
                .notification-title { color: #c0c0c0 !important; }
                .notification-message { color: #a0a0a0 !important; }
                .notification-timer { background: #c0c0c0 !important; }
            `;
            document.head.appendChild(style);
        }

        function applyAtlas3Style() {
            // Apply Atlas-3 style with soft, eye-friendly colors
            const menuContainer = document.getElementById('mainMenu');
            const header = document.getElementById('menuHeader');
            
            if (menuContainer) {
                menuContainer.style.background = 'rgba(0, 0, 0, 0.6)';
                menuContainer.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.6), inset 0 0 8px rgba(176, 196, 222, 0.1)';
            }
            
            if (header) {
                header.style.background = 'linear-gradient(135deg, rgba(25, 25, 50, 0.95) 0%, rgba(40, 50, 80, 0.95) 100%)';
                header.style.backgroundImage = 'url("style-image/ATLAS-3.png"), linear-gradient(135deg, rgba(25, 25, 50, 0.95) 0%, rgba(40, 50, 80, 0.95) 100%)';
                header.style.backgroundSize = 'cover, cover';
                header.style.backgroundPosition = 'center, center';
                header.style.backgroundRepeat = 'no-repeat, no-repeat';
            }
            
            // Update scrollbar colors
            const externalScrollbar = document.querySelector('.external-scrollbar');
            if (externalScrollbar) {
                externalScrollbar.style.background = 'rgba(0, 0, 0, 0.6)';
                externalScrollbar.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.6), inset 0 0 8px rgba(176, 196, 222, 0.1)';
            }
            
            // Update scrollbar indicator to soft blue theme
            const scrollbarIndicator = document.getElementById('scrollbarIndicator');
            if (scrollbarIndicator) {
                scrollbarIndicator.style.background = 'linear-gradient(180deg, #b0c4de 0%, #778899 100%)';
                scrollbarIndicator.style.boxShadow = '0 0 6px rgba(176, 196, 222, 0.6), 0 0 12px rgba(176, 196, 222, 0.3), inset 0 1px 1px rgba(255, 255, 255, 0.2)';
                scrollbarIndicator.style.border = '1px solid rgba(176, 196, 222, 0.5)';
            }
            
            // Update scroll arrows to soft blue
            const scrollArrows = document.querySelectorAll('.scroll-arrow');
            scrollArrows.forEach(arrow => {
                arrow.style.color = 'rgba(176, 196, 222, 0.7)';
            });
            
            // Update highlight bar to soft blue
            const highlightBar = document.querySelector('.highlight-bar');
            if (highlightBar) {
                highlightBar.style.background = 'rgba(176, 196, 222, 0.1)';
            }
            
            // Update selected text colors to soft blue
            const style = document.createElement('style');
            style.textContent = `
                .menu-item.selected .text { color: #b0c4de !important; }
                .menu-item.selected .icon { color: #b0c4de !important; }
                .menu-item.selected .arrow { color: #b0c4de !important; }
                .toggle-item.selected .toggle-text { color: #b0c4de !important; }
                .header-home-text { color: #b0c4de !important; }
                .menu-footer .counter { background: rgba(176, 196, 222, 0.1) !important; color: #b0c4de !important; box-shadow: 0 1px 3px rgba(176, 196, 222, 0.2) !important; }
                .notification { background: rgba(25, 25, 50, 0.95) !important; border: 1px solid rgba(176, 196, 222, 0.3) !important; }
                .notification-icon { color: #b0c4de !important; }
                .notification-title { color: #b0c4de !important; }
                .notification-message { color: #d3d3d3 !important; }
                .notification-timer { background: #b0c4de !important; }
            `;
            document.head.appendChild(style);
        }

        function resetToDefaultStyle() {
            // Reset to default Atlas theme with consistent colors
            const menuContainer = document.getElementById('mainMenu');
            const header = document.getElementById('menuHeader');
            
            if (menuContainer) {
                menuContainer.style.background = 'rgba(0, 0, 0, 0.6)';
                menuContainer.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.6), inset 0 0 8px rgba(255, 255, 255, 0.05)';
            }
            
            if (header) {
                header.style.background = 'linear-gradient(135deg, rgba(255, 215, 0, 0.95) 0%, rgba(255, 165, 0, 0.95) 100%)';
                header.style.backgroundImage = `url("${bannerImageUrl}"), linear-gradient(135deg, rgba(255, 215, 0, 0.95) 0%, rgba(255, 165, 0, 0.95) 100%)`;
                header.style.backgroundSize = 'cover, cover';
                header.style.backgroundPosition = 'center, center';
                header.style.backgroundRepeat = 'no-repeat, no-repeat';
            }
            
            // Reset scrollbar colors to Atlas theme
            const externalScrollbar = document.querySelector('.external-scrollbar');
            if (externalScrollbar) {
                externalScrollbar.style.background = 'rgba(0, 0, 0, 0.6)';
                externalScrollbar.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.6), inset 0 0 8px rgba(255, 255, 255, 0.05)';
            }
            
            // Reset scrollbar indicator to Atlas theme
            const scrollbarIndicator = document.getElementById('scrollbarIndicator');
            if (scrollbarIndicator) {
                scrollbarIndicator.style.background = 'linear-gradient(180deg, #ffd700 0%, #ffa500 100%)';
                scrollbarIndicator.style.boxShadow = '0 0 6px rgba(255, 215, 0, 0.8), 0 0 12px rgba(255, 215, 0, 0.4), inset 0 1px 1px rgba(255, 255, 255, 0.3)';
                scrollbarIndicator.style.border = '1px solid rgba(255, 215, 0, 0.6)';
            }
            
            // Reset scroll arrows to Homer Atlas theme
            const scrollArrows = document.querySelectorAll('.scroll-arrow');
            scrollArrows.forEach(arrow => {
                arrow.style.color = 'rgba(255, 215, 0, 0.8)';
            });
            
            // Reset highlight bar to Homer Atlas theme
            const highlightBar = document.querySelector('.highlight-bar');
            if (highlightBar) {
                highlightBar.style.background = 'rgba(255, 215, 0, 0.15)';
            }
            
            // Apply Homer Atlas default colors
            const style = document.createElement('style');
            style.textContent = `
                .menu-item.selected .text { color: #ffd700 !important; }
                .menu-item.selected .icon { color: #ffd700 !important; }
                .menu-item.selected .arrow { color: #ffd700 !important; }
                .toggle-item.selected .toggle-text { color: #ffd700 !important; }
                .header-home-text { color: #ffd700 !important; }
                .menu-footer .counter { background: rgba(255, 215, 0, 0.15) !important; color: #ffd700 !important; box-shadow: 0 1px 3px rgba(255, 215, 0, 0.3) !important; }
                .notification { background: rgba(25, 25, 25, 0.95) !important; border: 1px solid rgba(255, 215, 0, 0.4) !important; }
                .notification-icon { color: #ffd700 !important; }
                .notification-title { color: #ffd700 !important; }
                .notification-message { color: #ffa500 !important; }
                .notification-timer { background: #ffd700 !important; }
            `;
            document.head.appendChild(style);
        }

        function navigateBack() {
            if (currentMenuType === 'self') {
                currentMenuType = 'main';
                menuPath = ['HOME'];
                updateBreadcrumb();
                renderMenuItems(currentMenuType);
                const selfIndex = menuData.main.items.findIndex(item => item.action === 'self');
                updateSelection(selfIndex >= 0 ? selfIndex : 0, currentMenuType);
                // Reset scroll position
                const menuItems = document.getElementById('menuItemsContainer');
                if (menuItems) menuItems.scrollTop = 0;
                updateScrollbarIndicator();
            } else if (currentMenuType === 'settings') {
                currentMenuType = 'main';
                menuPath = ['HOME'];
                updateBreadcrumb();
                renderMenuItems(currentMenuType);
                const settingsIndex = menuData.main.items.findIndex(item => item.action === 'settings');
                updateSelection(settingsIndex >= 0 ? settingsIndex : 0, currentMenuType);
                // Reset scroll position
                const menuItems = document.getElementById('menuItemsContainer');
                if (menuItems) menuItems.scrollTop = 0;
                updateScrollbarIndicator();
            } else if (currentMenuType === 'style') {
                currentMenuType = 'settings';
                menuPath = ['HOME', 'SETTINGS'];
                updateBreadcrumb();
                renderMenuItems(currentMenuType);
                updateSelection(0, currentMenuType);
                // Reset scroll position
                const menuItems = document.getElementById('menuItemsContainer');
                if (menuItems) menuItems.scrollTop = 0;
                updateScrollbarIndicator();
            }
        }

        function showNotification(title, message, iconHtml = '<i class="fa-solid fa-info-circle"></i>') {
            const notification = document.createElement('div');
            notification.className = 'notification';

            notification.innerHTML = `
                <div class="notification-content">
                    <div class="notification-icon">${iconHtml}</div> 
                    <div class="notification-text">
                        <div class="notification-title">${title}</div>
                        <div class="notification-message">${message}</div>
                    </div>
                </div>
                <div class="notification-timer"></div>
            `;

            notificationContainer.appendChild(notification);
            notification.style.animation = 'notificationFadeIn 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards';
            
            setTimeout(() => {
                notification.style.animation = 'notificationFadeOut 0.25s cubic-bezier(0.55, 0.085, 0.68, 0.53) forwards';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                    notification.style.animation = 'none'; 
                }, 250); 
            }, 3000); 
        }

        function updateScrollbarIndicator() {
            const currentItems = document.querySelectorAll('#menuItemsContainer .menu-item, #menuItemsContainer .back-arrow-item, #menuItemsContainer .toggle-item');
            const scrollbarIndicator = document.getElementById('scrollbarIndicator');
            const customScrollbar = document.querySelector('.custom-scrollbar');
            const menuItems = document.getElementById('menuItemsContainer');
            
            if (!scrollbarIndicator || !customScrollbar || !menuItems) {
                return;
            }
            
            if (currentItems.length === 0) {
                scrollbarIndicator.style.display = 'none';
                return;
            }
            
            const totalItems = currentItems.length;
            const scrollbarHeight = customScrollbar.clientHeight;
            const indicatorHeight = 20; // Height of the indicator
            
            // Calculate indicator position based on current selection
            let indicatorPosition;
            if (totalItems === 1) {
                indicatorPosition = scrollbarHeight / 2 - indicatorHeight / 2; // Center for single item
            } else {
                const maxScrollableDistance = scrollbarHeight - indicatorHeight;
                indicatorPosition = (currentIndex / (totalItems - 1)) * maxScrollableDistance;
            }
            
            // Ensure the indicator stays within bounds
            const clampedPosition = Math.max(0, Math.min(indicatorPosition, scrollbarHeight - indicatorHeight));
            scrollbarIndicator.style.top = clampedPosition + 'px';
            scrollbarIndicator.style.display = 'block';
        }

        function updateCustomScrollbar() {
            const menuItems = document.getElementById('menuItemsContainer');
            const scrollbarThumb = document.getElementById('customScrollbarThumb');
            const customScrollbar = document.querySelector('.custom-scrollbar');
            
            if (!menuItems || !scrollbarThumb || !customScrollbar) return;
            
            const scrollTop = menuItems.scrollTop;
            const scrollHeight = menuItems.scrollHeight;
            const clientHeight = menuItems.clientHeight;
            const scrollbarHeight = customScrollbar.clientHeight;
            
            if (scrollHeight <= clientHeight) {
                scrollbarThumb.style.display = 'none';
                return;
            }
            
            scrollbarThumb.style.display = 'block';
            
            const thumbHeight = Math.max(15, (clientHeight / scrollHeight) * scrollbarHeight * 0.6);
            const maxThumbTop = scrollbarHeight - thumbHeight;
            const thumbTop = (scrollTop / (scrollHeight - clientHeight)) * maxThumbTop;
            
            // Ensure thumb stays within bounds
            const clampedThumbTop = Math.max(0, Math.min(thumbTop, maxThumbTop));
            
            scrollbarThumb.style.height = thumbHeight + 'px';
            scrollbarThumb.style.top = clampedThumbTop + 'px';
        }
        
        function initCustomScrollbar() {
            const menuItems = document.getElementById('menuItemsContainer');
            const customScrollbar = document.querySelector('.custom-scrollbar');
            const scrollbarThumb = document.getElementById('customScrollbarThumb');
            const externalScrollbar = document.querySelector('.external-scrollbar');
            const scrollArrowUp = document.querySelector('.scroll-arrow-up');
            const scrollArrowDown = document.querySelector('.scroll-arrow-down');
            
            if (!menuItems || !customScrollbar || !scrollbarThumb || !externalScrollbar) return;
            
            // Update scrollbar on scroll
            menuItems.addEventListener('scroll', updateCustomScrollbar);
            
            // Handle scroll arrows
            if (scrollArrowUp) {
                scrollArrowUp.addEventListener('click', function() {
                    menuItems.scrollTop -= 50;
                    updateCustomScrollbar();
                });
            }
            
            if (scrollArrowDown) {
                scrollArrowDown.addEventListener('click', function() {
                    menuItems.scrollTop += 50;
                    updateCustomScrollbar();
                });
            }
            
            // Handle scrollbar click
            externalScrollbar.addEventListener('click', function(e) {
                if (e.target === externalScrollbar || e.target === customScrollbar) {
                    const rect = customScrollbar.getBoundingClientRect();
                    const clickY = e.clientY - rect.top;
                    const scrollRatio = clickY / rect.height;
                    
                    menuItems.scrollTop = scrollRatio * (menuItems.scrollHeight - menuItems.clientHeight);
                }
            });
            
            // Handle thumb drag
            let isDragging = false;
            let dragStartY = 0;
            let scrollStartTop = 0;
            
            scrollbarThumb.addEventListener('mousedown', function(e) {
                isDragging = true;
                dragStartY = e.clientY;
                scrollStartTop = menuItems.scrollTop;
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                
                const deltaY = e.clientY - dragStartY;
                const scrollbarHeight = customScrollbar.clientHeight;
                const scrollRatio = deltaY / scrollbarHeight;
                
                menuItems.scrollTop = scrollStartTop + scrollRatio * (menuItems.scrollHeight - menuItems.clientHeight);
                e.preventDefault();
            });
            
            document.addEventListener('mouseup', function() {
                isDragging = false;
            });
            
            // Initial update
            updateCustomScrollbar();
        }

        // Add Macho DUI specific optimizations
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸš€ DOM loaded, setting up menu with Macho DUI optimizations...');
            console.log('ðŸ“¸ Banner image URL:', bannerImageUrl);
            
            // Add Macho DUI performance optimizations
            if (window.requestIdleCallback) {
                requestIdleCallback(() => {
                    console.log('âš¡ Using requestIdleCallback for Macho DUI optimization');
                });
            }
            
            renderMenuItems('main');
            updateSelection(0, 'main');
            updateBreadcrumb();
            initCustomScrollbar();
            updateScrollbarIndicator();
            
            // Apply default Atlas style on load
            resetToDefaultStyle();
            
            // Set header image immediately and with a fallback
            setHeaderImage(bannerImageUrl);
            
            // Also try again after a short delay to ensure it loads
            setTimeout(() => {
                console.log('ðŸ”„ Retrying image load...');
                setHeaderImage(bannerImageUrl);
            }, 500);
            
            // Add keyboard navigation support
            setupKeyboardNavigation();
        });

        // Enhanced keyboard navigation system
        function setupKeyboardNavigation() {
            console.log('âŒ¨ï¸ Setting up keyboard navigation...');
            
            // Make menu container focusable
            const menuContainer = document.getElementById('mainMenu');
            if (menuContainer) {
                menuContainer.setAttribute('tabindex', '0');
                menuContainer.style.outline = 'none'; // Remove default focus outline
            }
            
            // Add global keydown event listener
            document.addEventListener('keydown', handleKeyDown);
            
            // Focus management for DUI
            window.addEventListener('focus', handleWindowFocus);
            window.addEventListener('blur', handleWindowBlur);
            
            console.log('âœ… Keyboard navigation initialized');
        }
        
        function handleKeyDown(event) {
            // Only handle keys when menu is visible
            if (!menuContainer || menuContainer.style.display === 'none') {
                return;
            }
            
            // Ensure window has focus for DUI
            if (document.hasFocus()) {
                window.focus();
            }
            
            const currentItems = document.querySelectorAll('#menuItemsContainer .menu-item, #menuItemsContainer .toggle-item');
            if (currentItems.length === 0) return;
            
            let handled = false;
            
            switch(event.key) {
                case 'ArrowUp':
                    event.preventDefault();
                    currentIndex = currentIndex > 0 ? currentIndex - 1 : currentItems.length - 1;
                    updateSelection(currentIndex, currentMenuType);
                    syncSelectionWithLua('moveUp');
                    handled = true;
                    break;
                    
                case 'ArrowDown':
                    event.preventDefault();
                    currentIndex = (currentIndex + 1) % currentItems.length;
                    updateSelection(currentIndex, currentMenuType);
                    syncSelectionWithLua('moveDown');
                    handled = true;
                    break;
                    
                case 'Enter':
                    event.preventDefault();
                    const selectedItemData = menuData[currentMenuType].items[currentIndex];
                    if (selectedItemData) {
                        if (selectedItemData.type === 'toggle') {
                            // Handle toggle items
                            const domElement = document.querySelector(`[data-index="${currentIndex}"][data-action="${selectedItemData.action}"]`);
                            if (domElement) {
                                domElement.click();
                            }
                        } else {
                            // Handle regular menu items
                            selectEffect(currentIndex, currentMenuType);
                        }
                        syncSelectionWithLua('enter');
                    }
                    handled = true;
                    break;
                    
                case 'Backspace':
                    event.preventDefault();
                    navigateBack();
                    syncSelectionWithLua('back');
                    handled = true;
                    break;
                    
                case 'Escape':
                    event.preventDefault();
                    if (currentMenuType !== 'main') {
                        navigateBack();
                        syncSelectionWithLua('back');
                    }
                    handled = true;
                    break;
            }
            
            if (handled) {
                // Update scrollbar after navigation
                setTimeout(() => {
                    updateCustomScrollbar();
                    updateScrollbarIndicator();
                }, 50);
            }
        }
        
        function handleWindowFocus() {
            console.log('ðŸŽ¯ Window focused - DUI ready for keyboard input');
            // Ensure menu container can receive focus
            const menuContainer = document.getElementById('mainMenu');
            if (menuContainer && menuContainer.style.display !== 'none') {
                menuContainer.focus();
            }
        }
        
        function handleWindowBlur() {
            console.log('ðŸ‘ï¸ Window lost focus');
        }
        
        function syncSelectionWithLua(action) {
            // Sync current selection with Lua to prevent desync
            if (typeof GetParentResourceName !== 'undefined') {
                try {
                    fetch(`https://${GetParentResourceName()}/syncSelection`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json; charset=UTF-8' },
                        body: JSON.stringify({ 
                            action: action, 
                            currentIndex: currentIndex, 
                            menuType: currentMenuType 
                        })
                    }).catch(error => console.warn('Failed to sync with Lua:', error));
                } catch (error) {
                    console.warn('Error syncing with Lua:', error);
                }
            }
        }

        // Enhanced menu show/hide with focus management
        function showMenu() {
            menuContainer.style.display = 'flex';
            menuContainer.style.opacity = '1';
            menuContainer.style.transform = 'none';
            
            // Focus management for DUI
            setTimeout(() => {
                window.focus();
                menuContainer.focus();
                console.log('ðŸŽ¯ Menu focused and ready for keyboard input');
            }, 100);
            
            renderMenuItems(currentMenuType);
            updateSelection(currentIndex, currentMenuType);
        }
        
        function hideMenu() {
            menuContainer.style.display = 'none';
            // Remove focus when hiding
            menuContainer.blur();
        }

        window.addEventListener('message', function(event) {
            const data = event.data;
            try {
                // Add Macho DUI message validation
                if (!data || typeof data !== 'object') {
                    console.warn('âš ï¸ Invalid message data received:', data);
                    return;
                }

                // Add timestamp validation for Macho DUI optimization
                if (data.timestamp && typeof data.timestamp === 'number') {
                    const messageAge = Date.now() - data.timestamp;
                    if (messageAge > 5000) { // 5 second threshold
                        console.warn('âš ï¸ Message too old, ignoring:', messageAge + 'ms');
                        return;
                    }
                }

                if (data.type === 'updateSelection') {
                    const currentItems = document.querySelectorAll('#menuItemsContainer .menu-item, #menuItemsContainer .back-arrow-item, #menuItemsContainer .toggle-item');
                    const targetIndex = data.currentIndex !== undefined ? data.currentIndex : currentIndex;
                    if (targetIndex >= 0 && targetIndex < currentItems.length) {
                        updateSelection(targetIndex, currentMenuType);
                    }
                } else if (data.type === 'selectEffect') {
                    selectEffect(currentIndex, currentMenuType);
                } else if (data.type === 'moveUp') {
                    const currentItems = document.querySelectorAll('#menuItemsContainer .menu-item, #menuItemsContainer .toggle-item');
                    if (currentItems.length > 0) {
                        currentIndex = (currentIndex - 1 + currentItems.length) % currentItems.length;
                        updateSelection(currentIndex, currentMenuType);
                        setTimeout(() => {
                            updateCustomScrollbar();
                            updateScrollbarIndicator();
                        }, 50);
                    }
                } else if (data.type === 'moveDown') {
                    const currentItems = document.querySelectorAll('#menuItemsContainer .menu-item, #menuItemsContainer .toggle-item');
                    if (currentItems.length > 0) {
                        currentIndex = (currentIndex + 1) % currentItems.length;
                        updateSelection(currentIndex, currentMenuType);
                        setTimeout(() => {
                            updateCustomScrollbar();
                            updateScrollbarIndicator();
                        }, 50);
                    }
                } else if (data.type === 'enter') {
                    const selectedItemData = menuData[currentMenuType].items[currentIndex];
                    if (selectedItemData && selectedItemData.type === 'toggle') {
                        const domElement = document.querySelector(`[data-index="${currentIndex}"][data-action="${selectedItemData.action}"]`);
                        if (domElement) {
                            domElement.click(); 
                        }
                    } else {
                        selectEffect(currentIndex, currentMenuType); 
                    }
                } else if (data.type === 'showMenu') { 
                    showMenu();
                } else if (data.type === 'hideMenu') { 
                    hideMenu();
                } else if (data.type === 'back') { 
                    navigateBack();
                } else if (data.type === 'setHeaderImage') {
                    setHeaderImage(data.imageUrl); 
                } else if (data.type === 'showCustomNotification') {
                    showNotification(data.title || 'Notification', data.message || 'Custom message from server.', data.iconHtml);
                } else {
                    // Log unknown message types for debugging
                    console.log('ðŸ“¨ Unknown message type received:', data.type, data);
                }
            } catch (error) {
                console.error('âŒ Error processing message from FiveM:', error);
                console.error('ðŸ“¨ Message data:', data);
            }
        });
    </script>
</body>
</html>
