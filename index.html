<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lean Menu - Elite Edition</title> 
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="menu-wrapper">
                    <div class="external-scrollbar">
                <div class="scroll-arrow scroll-arrow-up">▲</div>
                <div class="custom-scrollbar">
                    <div class="custom-scrollbar-thumb" id="customScrollbarThumb"></div>
                    <div class="scrollbar-indicator" id="scrollbarIndicator"></div>
                </div>
                <div class="scroll-arrow scroll-arrow-down">▼</div>
            </div>
        
        <div class="menu-container" id="mainMenu">
            <div class="menu-header" id="menuHeader">
                <div class="header-home-text" id="headerText">HOME</div> 
            </div>

            <div class="menu-items" id="menuItemsContainer">
                <div class="highlight-bar"></div> 
            </div>

            <div class="menu-footer">
                <span class="version">Version: Beta | 24hrs ago | Created By 0oox</span>
                <span class="counter" id="counter">1/9</span> 
            </div>
        </div>
    </div>

    <div class="notification-container" id="notificationContainer">
    </div>

    <script>
        const bannerImageUrl = 'style-image/Atlas.png'; // Default Homer Atlas header image 

        let currentIndex = 0; 
        let currentMenuType = 'main';
        let menuPath = ['HOME'];

        const menuContainer = document.getElementById('mainMenu'); 
        const headerText = document.getElementById('headerText'); 
        const menuItemsContainer = document.getElementById('menuItemsContainer'); 
        let highlightBar = document.querySelector('.highlight-bar'); 
        const counterElement = document.getElementById('counter'); 
        const notificationContainer = document.getElementById('notificationContainer');

        const menuData = {
            main: {
                title: 'HOME',
                items: [
                    { name: "Self", icon: '<i class="fa-solid fa-user"></i>', desc: "Player Options", action: "self" },
                    { name: "Online", icon: '<i class="fa-solid fa-desktop"></i>', desc: "Online Features", action: "online" },
                    { name: "Combat/Weapons", icon: '<i class="fa-solid fa-crosshairs"></i>', desc: "Weapon System", action: "combat" },
                    { name: "Visual", icon: '<i class="fa-solid fa-eye"></i>', desc: "Visual Effects", action: "visual" },
                    { name: "Vehicle", icon: '<i class="fa-solid fa-car"></i>', desc: "Vehicle Menu", action: "vehicle" },
                    { name: "Miscellaneous", icon: '<i class="fa-solid fa-folder-open"></i>', desc: "Other Options", action: "misc" },
                    { name: "Destructive", icon: '<i class="fa-solid fa-bomb"></i>', desc: "Destruction Tools", action: "destructive" },
                    { name: "Triggers", icon: '<i class="fa-solid fa-bolt"></i>', desc: "Event Triggers", action: "triggers" },
                    { name: "Settings", icon: '<i class="fa-solid fa-gear"></i>', desc: "System Settings", action: "settings" }
                ]
            },
            self: {
                title: 'SELF',
                items: [
                    { name: "Noclip", action: "noclip_toggle", type: "toggle", checked: false },
                ]
            },
            settings: {
                title: 'SETTINGS',
                items: [
                    { name: "Style", icon: '<i class="fa-solid fa-palette"></i>', desc: "Menu Style Options", action: "style" },
                ]
            },
            style: {
                title: 'STYLE',
                items: [
                    { name: "ATLAS-1", icon: '<i class="fa-solid fa-1"></i>', desc: "Style Option 1", action: "style_1" },
                    { name: "ATLAS-2", icon: '<i class="fa-solid fa-2"></i>', desc: "Style Option 2", action: "style_2" },
                    { name: "ATLAS-3", icon: '<i class="fa-solid fa-3"></i>', desc: "Style Option 3", action: "style_3" },
                ]
            }
        };

        function renderMenuItems(menuType) {
            const currentMenuData = menuData[menuType];
            let itemsHtml = '<div class="highlight-bar"></div>'; 

            currentMenuData.items.forEach((item, index) => {
                if (item.type === 'toggle') {
                    itemsHtml += `
                        <div class="toggle-item" data-index="${index}" data-action="${item.action}">
                            <div class="toggle-text">${item.name}</div>
                            <div class="toggle-switch ${item.checked ? 'on' : 'off'}"></div>
                        </div>
                    `;
                } else {
                    itemsHtml += `
                        <div class="menu-item" data-index="${index}" data-action="${item.action}">
                            <div class="icon">${item.icon}</div>
                            <div class="text">${item.name}</div>
                            <div class="arrow">»</div>
                        </div>
                    `;
                }
            });
            menuItemsContainer.innerHTML = itemsHtml;
            
            highlightBar = document.querySelector('.highlight-bar');

            const renderedItems = document.querySelectorAll('#menuItemsContainer .menu-item, #menuItemsContainer .toggle-item');
            
            // Update custom scrollbar after rendering new items
            setTimeout(() => {
                updateCustomScrollbar();
                updateScrollbarIndicator();
            }, 10);
            
            renderedItems.forEach(itemElement => {
                itemElement.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    const action = this.dataset.action;
                    const itemData = menuData[currentMenuType].items[index];

                    if (itemElement.classList.contains('toggle-item')) {
                        itemData.checked = !itemData.checked;
                        const toggleSwitch = itemElement.querySelector('.toggle-switch');
                        toggleSwitch.classList.toggle('on', itemData.checked);
                        toggleSwitch.classList.toggle('off', !itemData.checked);

                        if (typeof GetParentResourceName !== 'undefined') {
                            fetch(`https://${GetParentResourceName()}/noclipToggle`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json; charset=UTF-8' },
                                body: JSON.stringify({ state: itemData.checked })
                            }).catch(error => console.error('Error sending noclipToggle:', error));
                        }

                        showNotification(
                            itemData.checked ? 'Noclip Activated' : 'Noclip Deactivated',
                            itemData.checked ? 'Noclip mode enabled.' : 'Noclip mode disabled.',
                            itemData.checked ? '<i class="fa-solid fa-toggle-on"></i>' : '<i class="fa-solid fa-toggle-off"></i>'
                        );

                        updateSelection(index, currentMenuType);
                    } else {
                        updateSelection(index, currentMenuType);
                        selectEffect(index, currentMenuType);
                    }
                });
            });

            return renderedItems; 
        }

        function setHeaderImage(imageUrl) {
            const header = document.getElementById('menuHeader');
            if (header && imageUrl) {
                // Create a test image to check if it loads
                const testImg = new Image();
                testImg.onload = function() {
                    console.log('✅ Image loaded successfully:', imageUrl);
                    header.style.backgroundImage = `url('${imageUrl}'), linear-gradient(135deg, rgba(255, 215, 0, 0.95) 0%, rgba(255, 165, 0, 0.95) 100%)`;
                    header.style.backgroundSize = 'cover, cover';
                    header.style.backgroundPosition = 'center, center';
                    header.style.backgroundRepeat = 'no-repeat, no-repeat';
                };
                testImg.onerror = function() {
                    console.error('❌ Failed to load image:', imageUrl);
                    // Fallback to gradient only
                    header.style.backgroundImage = 'linear-gradient(135deg, rgba(255, 215, 0, 0.95) 0%, rgba(255, 165, 0, 0.95) 100%)';
                };
                testImg.src = imageUrl;
            }
        }

        function updateSelection(index, menuType) {
            const currentItems = document.querySelectorAll('#menuItemsContainer .menu-item, #menuItemsContainer .toggle-item');
            const totalItems = currentItems.length;

            if (currentItems[currentIndex]) {
                currentItems[currentIndex].classList.remove('selected');
            }
            
            currentIndex = index;

            if (totalItems > 0 && index >= 0 && index < totalItems) {
                currentItems[index].classList.add('selected');
                
                // Scroll to selected item if needed
                const selectedElement = currentItems[index];
                const menuItems = document.getElementById('menuItemsContainer');
                const itemTop = selectedElement.offsetTop;
                const itemHeight = selectedElement.offsetHeight;
                const containerHeight = menuItems.clientHeight;
                const scrollTop = menuItems.scrollTop;
                
                if (itemTop < scrollTop) {
                    menuItems.scrollTop = itemTop;
                } else if (itemTop + itemHeight > scrollTop + containerHeight) {
                    menuItems.scrollTop = itemTop + itemHeight - containerHeight;
                }
            }

            if (highlightBar) {
                if (totalItems > 0 && index >= 0 && index < totalItems) {
                    const selectedElement = currentItems[index]; 
                    const topPosition = selectedElement.offsetTop; 
                    highlightBar.style.top = `${topPosition}px`; 
                    highlightBar.style.display = 'block';
                } else {
                    highlightBar.style.display = 'none';
                }
            }
            
            // Update scrollbar indicator
            updateScrollbarIndicator();
            
            counterElement.textContent = `${(totalItems > 0 && index >= 0) ? index + 1 : 0}/${totalItems}`;
        }

        function selectEffect(index, menuType) {
            const selectedOption = menuData[menuType].items[index];
            if (!selectedOption) return;

            if (menuType === 'main' && selectedOption.action === 'self') {
                currentMenuType = 'self';
                menuPath = ['HOME', 'SELF'];
                updateBreadcrumb();
                renderMenuItems(currentMenuType);
                updateSelection(0, currentMenuType);
                updateScrollbarIndicator();
            } else if (menuType === 'main' && selectedOption.action === 'settings') {
                currentMenuType = 'settings';
                menuPath = ['HOME', 'SETTINGS'];
                updateBreadcrumb();
                renderMenuItems(currentMenuType);
                updateSelection(0, currentMenuType);
                updateScrollbarIndicator();
            } else if (menuType === 'settings' && selectedOption.action === 'style') {
                currentMenuType = 'style';
                menuPath = ['HOME', 'SETTINGS', 'STYLE'];
                updateBreadcrumb();
                renderMenuItems(currentMenuType);
                updateSelection(0, currentMenuType);
                updateScrollbarIndicator();
            } else if (selectedOption.action === 'style_1') {
                applyAtlasStyle();
                showNotification('Style Applied', 'Atlas-1 style has been applied to the menu.', 3000, "success");
            } else if (selectedOption.action === 'style_2') {
                applyAtlas2Style();
                showNotification('Style Applied', 'Atlas-2 style has been applied to the menu.', 3000, "success");
            } else if (selectedOption.action === 'style_3') {
                applyAtlas3Style();
                showNotification('Style Applied', 'Atlas-3 style has been applied to the menu.', 3000, "success");
            } else if (typeof GetParentResourceName !== 'undefined') {
                fetch(`https://${GetParentResourceName()}/menuSelected`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json; charset=UTF-8' },
                    body: JSON.stringify({ action: selectedOption.action, index: index, menu: menuType })
                });
            }
        }

        function updateBreadcrumb() {
            if (headerText) {
                headerText.textContent = menuPath.join(' >> ');
            }
        }

        function applyAtlasStyle() {
            // Apply Atlas style with dark blue theme
            const menuContainer = document.getElementById('mainMenu');
            const header = document.getElementById('menuHeader');
            
            if (menuContainer) {
                menuContainer.style.background = 'rgba(0, 0, 0, 0.6)';
                menuContainer.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.6), inset 0 0 8px rgba(255, 255, 255, 0.05)';
            }
            
            if (header) {
                header.style.background = 'linear-gradient(135deg, rgba(30, 50, 80, 0.95) 0%, rgba(20, 35, 60, 0.95) 100%)';
                header.style.backgroundImage = 'url("style-image/ATLAS-1.png"), linear-gradient(135deg, rgba(30, 50, 80, 0.95) 0%, rgba(20, 35, 60, 0.95) 100%)';
                header.style.backgroundSize = 'cover, cover';
                header.style.backgroundPosition = 'center, center';
                header.style.backgroundRepeat = 'no-repeat, no-repeat';
            }
            
            // Update scrollbar colors
            const externalScrollbar = document.querySelector('.external-scrollbar');
            if (externalScrollbar) {
                externalScrollbar.style.background = 'rgba(0, 0, 0, 0.6)';
                externalScrollbar.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.6), inset 0 0 8px rgba(255, 255, 255, 0.05)';
            }
            
            // Update scrollbar indicator to white/blue theme
            const scrollbarIndicator = document.getElementById('scrollbarIndicator');
            if (scrollbarIndicator) {
                scrollbarIndicator.style.background = 'linear-gradient(180deg, #ffffff 0%, #e0e8ff 100%)';
                scrollbarIndicator.style.boxShadow = '0 0 6px rgba(255, 255, 255, 0.8), 0 0 12px rgba(255, 255, 255, 0.4), inset 0 1px 1px rgba(255, 255, 255, 0.3)';
                scrollbarIndicator.style.border = '1px solid rgba(255, 255, 255, 0.6)';
            }
            
            // Update scroll arrows to white
            const scrollArrows = document.querySelectorAll('.scroll-arrow');
            scrollArrows.forEach(arrow => {
                arrow.style.color = 'rgba(255, 255, 255, 0.8)';
            });
            
            // Update highlight bar to white/blue
            const highlightBar = document.querySelector('.highlight-bar');
            if (highlightBar) {
                highlightBar.style.background = 'rgba(255, 255, 255, 0.1)';
            }
            
            // Update selected text colors to white
            const style = document.createElement('style');
            style.textContent = `
                .menu-item.selected .text { color: #ffffff !important; }
                .menu-item.selected .icon { color: #ffffff !important; }
                .menu-item.selected .arrow { color: #ffffff !important; }
                .toggle-item.selected .toggle-text { color: #ffffff !important; }
                .header-home-text { color: #ffffff !important; }
                .menu-footer .counter { background: rgba(255, 255, 255, 0.1) !important; color: #ffffff !important; box-shadow: 0 1px 3px rgba(255, 255, 255, 0.2) !important; }
                .notification { background: rgba(15, 25, 45, 0.95) !important; border: 1px solid rgba(255, 255, 255, 0.4) !important; }
                .notification-icon { color: #ffffff !important; }
                .notification-title { color: #ffffff !important; }
                .notification-message { color: #e0e8ff !important; }
                .notification-timer { background: #ffffff !important; }
            `;
            document.head.appendChild(style);
        }

        function applyAtlas2Style() {
            // Apply Atlas-2 style with metallic silver theme
            const menuContainer = document.getElementById('mainMenu');
            const header = document.getElementById('menuHeader');
            
            if (menuContainer) {
                menuContainer.style.background = 'rgba(0, 0, 0, 0.6)';
                menuContainer.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.6), inset 0 0 8px rgba(192, 192, 192, 0.1)';
            }
            
            if (header) {
                header.style.background = 'linear-gradient(135deg, rgba(20, 30, 50, 0.95) 0%, rgba(15, 25, 40, 0.95) 100%)';
                header.style.backgroundImage = 'url("style-image/ATLAS-2.png"), linear-gradient(135deg, rgba(20, 30, 50, 0.95) 0%, rgba(15, 25, 40, 0.95) 100%)';
                header.style.backgroundSize = 'cover, cover';
                header.style.backgroundPosition = 'center, center';
                header.style.backgroundRepeat = 'no-repeat, no-repeat';
            }
            
            // Update scrollbar colors
            const externalScrollbar = document.querySelector('.external-scrollbar');
            if (externalScrollbar) {
                externalScrollbar.style.background = 'rgba(0, 0, 0, 0.6)';
                externalScrollbar.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.6), inset 0 0 8px rgba(192, 192, 192, 0.1)';
            }
            
            // Update scrollbar indicator to metallic silver theme
            const scrollbarIndicator = document.getElementById('scrollbarIndicator');
            if (scrollbarIndicator) {
                scrollbarIndicator.style.background = 'linear-gradient(180deg, #c0c0c0 0%, #a0a0a0 100%)';
                scrollbarIndicator.style.boxShadow = '0 0 6px rgba(192, 192, 192, 0.8), 0 0 12px rgba(192, 192, 192, 0.4), inset 0 1px 1px rgba(255, 255, 255, 0.3)';
                scrollbarIndicator.style.border = '1px solid rgba(192, 192, 192, 0.6)';
            }
            
            // Update scroll arrows to metallic silver
            const scrollArrows = document.querySelectorAll('.scroll-arrow');
            scrollArrows.forEach(arrow => {
                arrow.style.color = 'rgba(192, 192, 192, 0.8)';
            });
            
            // Update highlight bar to metallic silver
            const highlightBar = document.querySelector('.highlight-bar');
            if (highlightBar) {
                highlightBar.style.background = 'rgba(192, 192, 192, 0.15)';
            }
            
            // Update selected text colors to metallic silver
            const style = document.createElement('style');
            style.textContent = `
                .menu-item.selected .text { color: #c0c0c0 !important; }
                .menu-item.selected .icon { color: #c0c0c0 !important; }
                .menu-item.selected .arrow { color: #c0c0c0 !important; }
                .toggle-item.selected .toggle-text { color: #c0c0c0 !important; }
                .header-home-text { color: #c0c0c0 !important; }
                .menu-footer .counter { background: rgba(192, 192, 192, 0.15) !important; color: #c0c0c0 !important; box-shadow: 0 1px 3px rgba(192, 192, 192, 0.3) !important; }
                .notification { background: rgba(20, 30, 50, 0.95) !important; border: 1px solid rgba(192, 192, 192, 0.4) !important; }
                .notification-icon { color: #c0c0c0 !important; }
                .notification-title { color: #c0c0c0 !important; }
                .notification-message { color: #a0a0a0 !important; }
                .notification-timer { background: #c0c0c0 !important; }
            `;
            document.head.appendChild(style);
        }

        function applyAtlas3Style() {
            // Apply Atlas-3 style with soft, eye-friendly colors
            const menuContainer = document.getElementById('mainMenu');
            const header = document.getElementById('menuHeader');
            
            if (menuContainer) {
                menuContainer.style.background = 'rgba(0, 0, 0, 0.6)';
                menuContainer.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.6), inset 0 0 8px rgba(176, 196, 222, 0.1)';
            }
            
            if (header) {
                header.style.background = 'linear-gradient(135deg, rgba(25, 25, 50, 0.95) 0%, rgba(40, 50, 80, 0.95) 100%)';
                header.style.backgroundImage = 'url("style-image/ATLAS-3.png"), linear-gradient(135deg, rgba(25, 25, 50, 0.95) 0%, rgba(40, 50, 80, 0.95) 100%)';
                header.style.backgroundSize = 'cover, cover';
                header.style.backgroundPosition = 'center, center';
                header.style.backgroundRepeat = 'no-repeat, no-repeat';
            }
            
            // Update scrollbar colors
            const externalScrollbar = document.querySelector('.external-scrollbar');
            if (externalScrollbar) {
                externalScrollbar.style.background = 'rgba(0, 0, 0, 0.6)';
                externalScrollbar.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.6), inset 0 0 8px rgba(176, 196, 222, 0.1)';
            }
            
            // Update scrollbar indicator to soft blue theme
            const scrollbarIndicator = document.getElementById('scrollbarIndicator');
            if (scrollbarIndicator) {
                scrollbarIndicator.style.background = 'linear-gradient(180deg, #b0c4de 0%, #778899 100%)';
                scrollbarIndicator.style.boxShadow = '0 0 6px rgba(176, 196, 222, 0.6), 0 0 12px rgba(176, 196, 222, 0.3), inset 0 1px 1px rgba(255, 255, 255, 0.2)';
                scrollbarIndicator.style.border = '1px solid rgba(176, 196, 222, 0.5)';
            }
            
            // Update scroll arrows to soft blue
            const scrollArrows = document.querySelectorAll('.scroll-arrow');
            scrollArrows.forEach(arrow => {
                arrow.style.color = 'rgba(176, 196, 222, 0.7)';
            });
            
            // Update highlight bar to soft blue
            const highlightBar = document.querySelector('.highlight-bar');
            if (highlightBar) {
                highlightBar.style.background = 'rgba(176, 196, 222, 0.1)';
            }
            
            // Update selected text colors to soft blue
            const style = document.createElement('style');
            style.textContent = `
                .menu-item.selected .text { color: #b0c4de !important; }
                .menu-item.selected .icon { color: #b0c4de !important; }
                .menu-item.selected .arrow { color: #b0c4de !important; }
                .toggle-item.selected .toggle-text { color: #b0c4de !important; }
                .header-home-text { color: #b0c4de !important; }
                .menu-footer .counter { background: rgba(176, 196, 222, 0.1) !important; color: #b0c4de !important; box-shadow: 0 1px 3px rgba(176, 196, 222, 0.2) !important; }
                .notification { background: rgba(25, 25, 50, 0.95) !important; border: 1px solid rgba(176, 196, 222, 0.3) !important; }
                .notification-icon { color: #b0c4de !important; }
                .notification-title { color: #b0c4de !important; }
                .notification-message { color: #d3d3d3 !important; }
                .notification-timer { background: #b0c4de !important; }
            `;
            document.head.appendChild(style);
        }

        function resetToDefaultStyle() {
            // Reset to default Atlas theme with consistent colors
            const menuContainer = document.getElementById('mainMenu');
            const header = document.getElementById('menuHeader');
            
            if (menuContainer) {
                menuContainer.style.background = 'rgba(0, 0, 0, 0.6)';
                menuContainer.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.6), inset 0 0 8px rgba(255, 255, 255, 0.05)';
            }
            
            if (header) {
                header.style.background = 'linear-gradient(135deg, rgba(255, 215, 0, 0.95) 0%, rgba(255, 165, 0, 0.95) 100%)';
                header.style.backgroundImage = `url("${bannerImageUrl}"), linear-gradient(135deg, rgba(255, 215, 0, 0.95) 0%, rgba(255, 165, 0, 0.95) 100%)`;
                header.style.backgroundSize = 'cover, cover';
                header.style.backgroundPosition = 'center, center';
                header.style.backgroundRepeat = 'no-repeat, no-repeat';
            }
            
            // Reset scrollbar colors to Atlas theme
            const externalScrollbar = document.querySelector('.external-scrollbar');
            if (externalScrollbar) {
                externalScrollbar.style.background = 'rgba(0, 0, 0, 0.6)';
                externalScrollbar.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.6), inset 0 0 8px rgba(255, 255, 255, 0.05)';
            }
            
            // Reset scrollbar indicator to Atlas theme
            const scrollbarIndicator = document.getElementById('scrollbarIndicator');
            if (scrollbarIndicator) {
                scrollbarIndicator.style.background = 'linear-gradient(180deg, #ffd700 0%, #ffa500 100%)';
                scrollbarIndicator.style.boxShadow = '0 0 6px rgba(255, 215, 0, 0.8), 0 0 12px rgba(255, 215, 0, 0.4), inset 0 1px 1px rgba(255, 255, 255, 0.3)';
                scrollbarIndicator.style.border = '1px solid rgba(255, 215, 0, 0.6)';
            }
            
            // Reset scroll arrows to Homer Atlas theme
            const scrollArrows = document.querySelectorAll('.scroll-arrow');
            scrollArrows.forEach(arrow => {
                arrow.style.color = 'rgba(255, 215, 0, 0.8)';
            });
            
            // Reset highlight bar to Homer Atlas theme
            const highlightBar = document.querySelector('.highlight-bar');
            if (highlightBar) {
                highlightBar.style.background = 'rgba(255, 215, 0, 0.15)';
            }
            
            // Apply Homer Atlas default colors
            const style = document.createElement('style');
            style.textContent = `
                .menu-item.selected .text { color: #ffd700 !important; }
                .menu-item.selected .icon { color: #ffd700 !important; }
                .menu-item.selected .arrow { color: #ffd700 !important; }
                .toggle-item.selected .toggle-text { color: #ffd700 !important; }
                .header-home-text { color: #ffd700 !important; }
                .menu-footer .counter { background: rgba(255, 215, 0, 0.15) !important; color: #ffd700 !important; box-shadow: 0 1px 3px rgba(255, 215, 0, 0.3) !important; }
                .notification { background: rgba(25, 25, 25, 0.95) !important; border: 1px solid rgba(255, 215, 0, 0.4) !important; }
                .notification-icon { color: #ffd700 !important; }
                .notification-title { color: #ffd700 !important; }
                .notification-message { color: #ffa500 !important; }
                .notification-timer { background: #ffd700 !important; }
            `;
            document.head.appendChild(style);
        }

        function navigateBack() {
            if (currentMenuType === 'self') {
                currentMenuType = 'main';
                menuPath = ['HOME'];
                updateBreadcrumb();
                renderMenuItems(currentMenuType);
                const selfIndex = menuData.main.items.findIndex(item => item.action === 'self');
                updateSelection(selfIndex >= 0 ? selfIndex : 0, currentMenuType);
                // Reset scroll position
                const menuItems = document.getElementById('menuItemsContainer');
                if (menuItems) menuItems.scrollTop = 0;
                updateScrollbarIndicator();
            } else if (currentMenuType === 'settings') {
                currentMenuType = 'main';
                menuPath = ['HOME'];
                updateBreadcrumb();
                renderMenuItems(currentMenuType);
                const settingsIndex = menuData.main.items.findIndex(item => item.action === 'settings');
                updateSelection(settingsIndex >= 0 ? settingsIndex : 0, currentMenuType);
                // Reset scroll position
                const menuItems = document.getElementById('menuItemsContainer');
                if (menuItems) menuItems.scrollTop = 0;
                updateScrollbarIndicator();
            } else if (currentMenuType === 'style') {
                currentMenuType = 'settings';
                menuPath = ['HOME', 'SETTINGS'];
                updateBreadcrumb();
                renderMenuItems(currentMenuType);
                updateSelection(0, currentMenuType);
                // Reset scroll position
                const menuItems = document.getElementById('menuItemsContainer');
                if (menuItems) menuItems.scrollTop = 0;
                updateScrollbarIndicator();
            }
        }

        function showNotification(title, message, iconHtml = '<i class="fa-solid fa-info-circle"></i>') {
            const notification = document.createElement('div');
            notification.className = 'notification';

            notification.innerHTML = `
                <div class="notification-content">
                    <div class="notification-icon">${iconHtml}</div> 
                    <div class="notification-text">
                        <div class="notification-title">${title}</div>
                        <div class="notification-message">${message}</div>
                    </div>
                </div>
                <div class="notification-timer"></div>
            `;

            notificationContainer.appendChild(notification);
            notification.style.animation = 'notificationFadeIn 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards';
            
            setTimeout(() => {
                notification.style.animation = 'notificationFadeOut 0.25s cubic-bezier(0.55, 0.085, 0.68, 0.53) forwards';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                    notification.style.animation = 'none'; 
                }, 250); 
            }, 3000); 
        }

        function updateScrollbarIndicator() {
            const currentItems = document.querySelectorAll('#menuItemsContainer .menu-item, #menuItemsContainer .back-arrow-item, #menuItemsContainer .toggle-item');
            const scrollbarIndicator = document.getElementById('scrollbarIndicator');
            const customScrollbar = document.querySelector('.custom-scrollbar');
            const menuItems = document.getElementById('menuItemsContainer');
            
            if (!scrollbarIndicator || !customScrollbar || !menuItems) {
                return;
            }
            
            if (currentItems.length === 0) {
                scrollbarIndicator.style.display = 'none';
                return;
            }
            
            const totalItems = currentItems.length;
            const scrollbarHeight = customScrollbar.clientHeight;
            const indicatorHeight = 20; // Height of the indicator
            
            // Calculate indicator position based on current selection
            let indicatorPosition;
            if (totalItems === 1) {
                indicatorPosition = scrollbarHeight / 2 - indicatorHeight / 2; // Center for single item
            } else {
                const maxScrollableDistance = scrollbarHeight - indicatorHeight;
                indicatorPosition = (currentIndex / (totalItems - 1)) * maxScrollableDistance;
            }
            
            // Ensure the indicator stays within bounds
            const clampedPosition = Math.max(0, Math.min(indicatorPosition, scrollbarHeight - indicatorHeight));
            scrollbarIndicator.style.top = clampedPosition + 'px';
            scrollbarIndicator.style.display = 'block';
        }

        function updateCustomScrollbar() {
            const menuItems = document.getElementById('menuItemsContainer');
            const scrollbarThumb = document.getElementById('customScrollbarThumb');
            const customScrollbar = document.querySelector('.custom-scrollbar');
            
            if (!menuItems || !scrollbarThumb || !customScrollbar) return;
            
            const scrollTop = menuItems.scrollTop;
            const scrollHeight = menuItems.scrollHeight;
            const clientHeight = menuItems.clientHeight;
            const scrollbarHeight = customScrollbar.clientHeight;
            
            if (scrollHeight <= clientHeight) {
                scrollbarThumb.style.display = 'none';
                return;
            }
            
            scrollbarThumb.style.display = 'block';
            
            const thumbHeight = Math.max(15, (clientHeight / scrollHeight) * scrollbarHeight * 0.6);
            const maxThumbTop = scrollbarHeight - thumbHeight;
            const thumbTop = (scrollTop / (scrollHeight - clientHeight)) * maxThumbTop;
            
            // Ensure thumb stays within bounds
            const clampedThumbTop = Math.max(0, Math.min(thumbTop, maxThumbTop));
            
            scrollbarThumb.style.height = thumbHeight + 'px';
            scrollbarThumb.style.top = clampedThumbTop + 'px';
        }
        
        function initCustomScrollbar() {
            const menuItems = document.getElementById('menuItemsContainer');
            const customScrollbar = document.querySelector('.custom-scrollbar');
            const scrollbarThumb = document.getElementById('customScrollbarThumb');
            const externalScrollbar = document.querySelector('.external-scrollbar');
            const scrollArrowUp = document.querySelector('.scroll-arrow-up');
            const scrollArrowDown = document.querySelector('.scroll-arrow-down');
            
            if (!menuItems || !customScrollbar || !scrollbarThumb || !externalScrollbar) return;
            
            // Update scrollbar on scroll
            menuItems.addEventListener('scroll', updateCustomScrollbar);
            
            // Handle scroll arrows
            if (scrollArrowUp) {
                scrollArrowUp.addEventListener('click', function() {
                    menuItems.scrollTop -= 50;
                    updateCustomScrollbar();
                });
            }
            
            if (scrollArrowDown) {
                scrollArrowDown.addEventListener('click', function() {
                    menuItems.scrollTop += 50;
                    updateCustomScrollbar();
                });
            }
            
            // Handle scrollbar click
            externalScrollbar.addEventListener('click', function(e) {
                if (e.target === externalScrollbar || e.target === customScrollbar) {
                    const rect = customScrollbar.getBoundingClientRect();
                    const clickY = e.clientY - rect.top;
                    const scrollRatio = clickY / rect.height;
                    
                    menuItems.scrollTop = scrollRatio * (menuItems.scrollHeight - menuItems.clientHeight);
                }
            });
            
            // Handle thumb drag
            let isDragging = false;
            let dragStartY = 0;
            let scrollStartTop = 0;
            
            scrollbarThumb.addEventListener('mousedown', function(e) {
                isDragging = true;
                dragStartY = e.clientY;
                scrollStartTop = menuItems.scrollTop;
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                
                const deltaY = e.clientY - dragStartY;
                const scrollbarHeight = customScrollbar.clientHeight;
                const scrollRatio = deltaY / scrollbarHeight;
                
                menuItems.scrollTop = scrollStartTop + scrollRatio * (menuItems.scrollHeight - menuItems.clientHeight);
                e.preventDefault();
            });
            
            document.addEventListener('mouseup', function() {
                isDragging = false;
            });
            
            // Initial update
            updateCustomScrollbar();
        }

        // Macho DUI performance monitoring
        window.machoDuiStats = {
            messagesReceived: 0,
            messagesProcessed: 0,
            errors: 0,
            lastMessageTime: 0,
            startTime: Date.now()
        };

        // Macho DUI initialization function
        window.auraMenuInit = function() {
            console.log('🎮 Aura Menu initialized via Macho DUI');
            
            // Initialize menu components
            renderMenuItems('main');
            updateSelection(0, 'main');
            updateBreadcrumb();
            initCustomScrollbar();
            updateScrollbarIndicator();
            
            // Apply default Atlas style on load
            resetToDefaultStyle();
            
            // Set header image immediately and with a fallback
            setHeaderImage(bannerImageUrl);
            
            // Also try again after a short delay to ensure it loads
            setTimeout(() => {
                console.log('🔄 Retrying image load...');
                setHeaderImage(bannerImageUrl);
            }, 500);
            
            // Send ready signal to Lua
            if (typeof GetParentResourceName !== 'undefined') {
                fetch(`https://${GetParentResourceName()}/menuReady`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json; charset=UTF-8' },
                    body: JSON.stringify({ 
                        status: 'ready',
                        timestamp: Date.now(),
                        version: 'Enhanced Macho DUI',
                        performance: {
                            domReady: Date.now() - window.machoDuiStats.startTime,
                            userAgent: navigator.userAgent
                        }
                    })
                }).catch(error => console.error('Error sending menuReady:', error));
            }
            
            // Log performance metrics
            console.log('⚡ Macho DUI Performance Metrics:', {
                initializationTime: Date.now() - window.machoDuiStats.startTime,
                domElements: document.querySelectorAll('*').length,
                menuItems: document.querySelectorAll('.menu-item, .toggle-item').length
            });
        };

        // Add Macho DUI specific optimizations
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DOM loaded, setting up menu with Macho DUI optimizations...');
            console.log('📸 Banner image URL:', bannerImageUrl);
            
            // Add Macho DUI performance optimizations
            if (window.requestIdleCallback) {
                requestIdleCallback(() => {
                    console.log('⚡ Using requestIdleCallback for Macho DUI optimization');
                    
                    // Initialize menu if not already done
                    if (typeof window.auraMenuInit === 'function') {
                        window.auraMenuInit();
                    }
                });
            } else {
                // Fallback for browsers without requestIdleCallback
                setTimeout(() => {
                    if (typeof window.auraMenuInit === 'function') {
                        window.auraMenuInit();
                    }
                }, 100);
            }
        });

        window.addEventListener('message', function(event) {
            const data = event.data;
            try {
                // Enhanced Macho DUI message validation
                if (!data || typeof data !== 'object') {
                    console.warn('⚠️ Invalid message data received:', data);
                    return;
                }

                // Enhanced timestamp validation for Macho DUI optimization
                if (data.timestamp && typeof data.timestamp === 'number') {
                    const messageAge = Date.now() - data.timestamp;
                    if (messageAge > 10000) { // 10 second threshold for Macho DUI
                        console.warn('⚠️ Message too old, ignoring:', messageAge + 'ms');
                        return;
                    }
                }

                // Update Macho DUI performance stats
                window.machoDuiStats.messagesReceived++;
                window.machoDuiStats.lastMessageTime = Date.now();
                
                // Log Macho DUI messages for debugging
                console.log('📨 Macho DUI message received:', data.type, data);

                switch(data.type) {
                    case 'updateSelection':
                        const currentItems = document.querySelectorAll('#menuItemsContainer .menu-item, #menuItemsContainer .back-arrow-item, #menuItemsContainer .toggle-item');
                        const targetIndex = data.currentIndex !== undefined ? data.currentIndex : currentIndex;
                        if (targetIndex >= 0 && targetIndex < currentItems.length) {
                            updateSelection(targetIndex, currentMenuType);
                        }
                        break;

                    case 'selectEffect':
                        selectEffect(currentIndex, currentMenuType);
                        break;

                    case 'moveUp':
                        const upItems = document.querySelectorAll('#menuItemsContainer .menu-item, #menuItemsContainer .toggle-item');
                        if (upItems.length > 0) {
                            currentIndex = (currentIndex - 1 + upItems.length) % upItems.length;
                            updateSelection(currentIndex, currentMenuType);
                            setTimeout(() => {
                                updateCustomScrollbar();
                                updateScrollbarIndicator();
                            }, 50);
                        }
                        break;

                    case 'moveDown':
                        const downItems = document.querySelectorAll('#menuItemsContainer .menu-item, #menuItemsContainer .toggle-item');
                        if (downItems.length > 0) {
                            currentIndex = (currentIndex + 1) % downItems.length;
                            updateSelection(currentIndex, currentMenuType);
                            setTimeout(() => {
                                updateCustomScrollbar();
                                updateScrollbarIndicator();
                            }, 50);
                        }
                        break;

                    case 'enter':
                        const selectedItemData = menuData[currentMenuType].items[currentIndex];
                        if (selectedItemData && selectedItemData.type === 'toggle') {
                            const domElement = document.querySelector(`[data-index="${currentIndex}"][data-action="${selectedItemData.action}"]`);
                            if (domElement) {
                                domElement.click(); 
                            }
                        } else {
                            selectEffect(currentIndex, currentMenuType); 
                        }
                        break;

                    case 'showMenu': 
                        menuContainer.style.display = 'flex';
                        menuContainer.style.opacity = '1';
                        menuContainer.style.transform = 'none'; 
                        renderMenuItems(currentMenuType);
                        updateSelection(currentIndex, currentMenuType);
                        console.log('🎮 Menu shown via Macho DUI');
                        break;

                    case 'hideMenu': 
                        menuContainer.style.display = 'none';
                        console.log('🎮 Menu hidden via Macho DUI');
                        break;

                    case 'back': 
                        navigateBack();
                        break;

                    case 'setHeaderImage':
                        setHeaderImage(data.imageUrl); 
                        break;

                    case 'showCustomNotification':
                        showNotification(data.title || 'Notification', data.message || 'Custom message from server.', data.iconHtml);
                        break;

                    case 'executeScript':
                        // Handle dynamic script execution from Macho DUI
                        if (data.script && typeof data.script === 'string') {
                            try {
                                console.log('⚡ Executing dynamic script from Macho DUI:', data.script);
                                eval(data.script);
                            } catch (scriptError) {
                                console.error('❌ Error executing dynamic script:', scriptError);
                            }
                        }
                        break;

                    case 'updateMenuData':
                        // Handle dynamic menu data updates from Macho DUI
                        if (data.menuData && typeof data.menuData === 'object') {
                            console.log('🔄 Updating menu data from Macho DUI:', data.menuData);
                            // Merge new menu data
                            Object.assign(menuData, data.menuData);
                            // Re-render current menu
                            renderMenuItems(currentMenuType);
                            updateSelection(currentIndex, currentMenuType);
                        }
                        break;

                    default:
                        // Log unknown message types for debugging
                        console.log('📨 Unknown Macho DUI message type received:', data.type, data);
                        break;
                }
            } catch (error) {
                console.error('❌ Error processing Macho DUI message:', error);
                console.error('📨 Message data:', data);
                window.machoDuiStats.errors++;
            }
        });

        // Macho DUI utility functions
        window.getMachoDuiStats = function() {
            return {
                ...window.machoDuiStats,
                uptime: Date.now() - window.machoDuiStats.startTime,
                messageRate: window.machoDuiStats.messagesReceived / Math.max(1, (Date.now() - window.machoDuiStats.startTime) / 1000)
            };
        };

        window.resetMachoDuiStats = function() {
            window.machoDuiStats = {
                messagesReceived: 0,
                messagesProcessed: 0,
                errors: 0,
                lastMessageTime: 0,
                startTime: Date.now()
            };
            console.log('🔄 Macho DUI stats reset');
        };

        // Log Macho DUI initialization
        console.log('🎮 Macho DUI system ready for Aura Menu');
    </script>
</body>
</html>
